name: SonarCloud Analysis on pr
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
          -Dsonar.sources=.
          -Dsonar.branch.name=${{ github.head_ref || github.ref_name }}
          -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
          -Dsonar.pullrequest.branch=${{ github.head_ref }}
          -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }}

    - name: Generate and post detailed metrics comment
      if: github.event_name == 'pull_request'
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        CURRENT_BRANCH: ${{ github.head_ref }}
        BASE_BRANCH: ${{ github.base_ref }}
      run: |
        #!/bin/bash
        set -e

        # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å®šç¾©
        METRICS="complexity,cognitive_complexity,lines"
        
        # ã‚³ãƒ¡ãƒ³ãƒˆã®åˆæœŸåŒ–
        COMMENT="## ğŸ” SonarCloudã‚³ãƒ¼ãƒ‰è¤‡é›‘æ€§åˆ†æ\n\n"
        
        # å·®åˆ†ãƒˆãƒ©ãƒƒã‚«ãƒ¼ã®åˆæœŸåŒ–
        TOTAL_COMPLEXITY_DIFF=0
        TOTAL_COG_COMPLEXITY_DIFF=0
        TOTAL_LINES_DIFF=0
        
        # ãƒˆãƒ¬ãƒ³ãƒ‰è¡¨ç¤ºé–¢æ•°
        get_trend_indicator() {
          local current=$1
          local target=$2
          local diff=$((current - target))
          
          if [[ $diff -gt 0 ]]; then
            echo "ğŸ“ˆ +$diff"
          elif [[ $diff -lt 0 ]]; then
            echo "ğŸ“‰ $diff"
          else
            echo "â¡ï¸ 0"
          fi
        }
        
        # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é–¢æ•°
        urlencode() {
          local raw="$1"
          local encoded=""
          for ((i=0; i<${#raw}; i++)); do
            local c="${raw:i:1}"
            case "$c" in
              [a-zA-Z0-9._~-]) encoded+="$c" ;;
              *) encoded+=$(printf '%%%02X' "'$c") ;;
            esac
          done
          echo "$encoded"
        }

        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
        CHANGED_FILES_JSON=$(curl -s -f -u "${SONAR_TOKEN}:" \
          "https://sonarcloud.io/api/measures/component_tree?branch=${CURRENT_BRANCH}&qualifiers=FIL&component=${PROJECT_KEY}&metricKeys=${METRICS}")
        
        # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•°ã®å–å¾—
        COMPONENT_COUNT=$(echo "${CHANGED_FILES_JSON}" | jq '.components | length')
        
        echo "Found ${COMPONENT_COUNT} components"

        # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼
        COMMENT+="| ãƒ•ã‚¡ã‚¤ãƒ« | å¾ªç’°çš„<br>è¤‡é›‘åº¦ | èªçŸ¥çš„<br>è¤‡é›‘åº¦ | ã‚³ãƒ¼ãƒ‰è¡Œæ•° |\n"
        COMMENT+="|:-----|:-------------|:-------------|:------------|\n"

        # å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‡¦ç†
        for ((i=0; i<COMPONENT_COUNT; i++)); do
          # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°å–å¾—
          COMPONENT=$(echo "${CHANGED_FILES_JSON}" | jq ".components[${i}]")
          FILE_KEY=$(urlencode $(echo "${COMPONENT}" | jq -r '.key'))
          FILE_PATH=$(echo "${COMPONENT}" | jq -r '.path')
          
          # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ç›´æ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
          COMPLEXITY_CURRENT=$(echo "${COMPONENT}" | jq -r '.measures[] | select(.metric == "complexity") | .value // "0"')
          COG_COMPLEXITY_CURRENT=$(echo "${COMPONENT}" | jq -r '.measures[] | select(.metric == "cognitive_complexity") | .value // "0"')
          LINES_CURRENT=$(echo "${COMPONENT}" | jq -r '.measures[] | select(.metric == "lines") | .value // "0"')
          
          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—
          TARGET_FILE_METRICS=$(curl -s -f -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/measures/component?branch=${BASE_BRANCH}&component=${FILE_KEY}&metricKeys=${METRICS}")
          
          # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ -z "$TARGET_FILE_METRICS" ]]; then
            continue
          fi
          
          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã®è¤‡é›‘æ€§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨ˆç®—
          COMPLEXITY_TARGET=$(echo "${TARGET_FILE_METRICS}" | jq -r '.component.measures[] | select(.metric == "complexity") | .value // "0"')
          COG_COMPLEXITY_TARGET=$(echo "${TARGET_FILE_METRICS}" | jq -r '.component.measures[] | select(.metric == "cognitive_complexity") | .value // "0"')
          LINES_TARGET=$(echo "${TARGET_FILE_METRICS}" | jq -r '.component.measures[] | select(.metric == "lines") | .value // "0"')
          
          COMPLEXITY_DIFF=$((COMPLEXITY_CURRENT - COMPLEXITY_TARGET))
          COG_COMPLEXITY_DIFF=$((COG_COMPLEXITY_CURRENT - COG_COMPLEXITY_TARGET))
          LINES_DIFF=$((LINES_CURRENT - LINES_TARGET))
          
          # ç·åˆçš„ãªå·®åˆ†ã®æ›´æ–°
          TOTAL_COMPLEXITY_DIFF=$((TOTAL_COMPLEXITY_DIFF + COMPLEXITY_DIFF))
          TOTAL_COG_COMPLEXITY_DIFF=$((TOTAL_COG_COMPLEXITY_DIFF + COG_COMPLEXITY_DIFF))
          TOTAL_LINES_DIFF=$((TOTAL_LINES_DIFF + LINES_DIFF))
          
          # ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®å–å¾—
          COMPLEXITY_TREND=$(get_trend_indicator $COMPLEXITY_CURRENT $COMPLEXITY_TARGET)
          COG_COMPLEXITY_TREND=$(get_trend_indicator $COG_COMPLEXITY_CURRENT $COG_COMPLEXITY_TARGET)
          LINES_TREND=$(get_trend_indicator $LINES_CURRENT $LINES_TARGET)
          
          # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
          COMMENT+="| \`${FILE_PATH}\` | ${COMPLEXITY_TARGET} â†’ ${COMPLEXITY_CURRENT} ${COMPLEXITY_TREND} | ${COG_COMPLEXITY_TARGET} â†’ ${COG_COMPLEXITY_CURRENT} ${COG_COMPLEXITY_TREND} | ${LINES_TARGET} â†’ ${LINES_CURRENT} ${LINES_TREND} |\n"
        done
        
        # ç·åˆçš„ãªå¤‰æ›´ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        COMMENT+="\n## ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®å¤‰åŒ–\n\n"
        COMMENT+="| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å‚¾å‘ |\n"
        COMMENT+="|:-------|:---------|\n"
        
        # å¾ªç’°çš„è¤‡é›‘åº¦ã®æ¦‚è¦
        COMPLEXITY_SUMMARY_TREND=$(get_trend_indicator $TOTAL_COMPLEXITY_DIFF 0)
        COMMENT+="| å¾ªç’°çš„è¤‡é›‘åº¦ | ${COMPLEXITY_SUMMARY_TREND} |\n"
        
        # èªçŸ¥çš„è¤‡é›‘åº¦ã®æ¦‚è¦
        COG_COMPLEXITY_SUMMARY_TREND=$(get_trend_indicator $TOTAL_COG_COMPLEXITY_DIFF 0)
        COMMENT+="| èªçŸ¥çš„è¤‡é›‘åº¦ | ${COG_COMPLEXITY_SUMMARY_TREND} |\n"
        
        # ã‚³ãƒ¼ãƒ‰è¡Œæ•°ã®æ¦‚è¦
        LINES_SUMMARY_TREND=$(get_trend_indicator $TOTAL_LINES_DIFF 0)
        COMMENT+="| ã‚³ãƒ¼ãƒ‰è¡Œæ•° | ${LINES_SUMMARY_TREND} |\n"
        
        # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo -e "$COMMENT" > comment.txt
        
        # ãƒ‡ãƒãƒƒã‚°ç”¨: ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
        cat comment.txt

    - name: Post comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('comment.txt', 'utf8');
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
